<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Integraci√≥n - Interfaz con lil-gui</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- lil-gui -->
  <script src="https://cdn.jsdelivr.net/npm/lil-gui/dist/lil-gui.umd.min.js"></script>
  <!-- math.js -->
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: #181e2a;
      color: #e5e7eb;
      overflow-x: hidden;
    }
    h2 {
      text-align: center;
      margin-top: 36px;
      margin-bottom: 18px;
      font-weight: 700;
      font-size: 2.1rem;
      letter-spacing: 0.01em;
      color: #f1f5fa;
      border-bottom: 2px solid #23293a;
      padding-bottom: 8px;
      background: none;
    }
    #container {
      display: flex;
      gap: 32px;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: center;
      padding: 0 24px 32px 24px;
    }
    #canvasCard {
      flex: 1 1 600px;
      min-width: 340px;
      max-width: 820px;
      background: #23293a;
      border-radius: 12px;
      box-shadow: 0 4px 24px 0 rgba(20, 30, 50, 0.25);
      padding: 28px 18px 18px 18px;
      border: 1.5px solid #2d3648;
      transition: box-shadow 0.2s, border-color 0.2s;
      position: relative;
    }
    #canvasCard:hover {
      box-shadow: 0 8px 32px 0 rgba(20, 30, 50, 0.33);
      border-color: #475569;
    }
    #info {
      width: 340px;
      min-width: 260px;
      background: #23293a;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(20,30,50,0.18);
      padding: 22px 18px 18px 18px;
      border: 1.5px solid #2d3648;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    canvas {
      background: #181e2a;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(20,30,50,0.18);
      transition: box-shadow 0.2s;
      margin-bottom: 8px;
      border: 1px solid #2d3648;
    }
    canvas:hover {
      box-shadow: 0 6px 18px rgba(20,30,50,0.28);
    }
    .result {
      margin-top: 0;
      padding: 14px 12px;
      border-radius: 7px;
      background: #1a2233;
      box-shadow: 0 1px 4px rgba(20,30,50,0.13);
      font-size: 1.08em;
      font-weight: 500;
      color: #e5e7eb;
      border: 1px solid #2d3648;
      min-height: 56px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .result.animated {
      animation: popResult 0.5s;
    }
    .hint {
      font-size: 0.93em;
      color: #a3aed6;
      margin-top: 8px;
      opacity: 0.85;
      font-weight: 400;
    }
    #guiContainer .lil-gui {
      --width: 100%;
      border-radius: 7px;
      box-shadow: 0 1px 4px rgba(20,30,50,0.13);
      background: #181e2a;
      border: 1px solid #2d3648;
      margin-bottom: 0;
      font-size: 1em;
      color: #e5e7eb;
    }
    #guiContainer .lil-gui .title {
      font-weight: 600;
      color: #e5e7eb;
    }
    /* Animaciones */
    @keyframes popResult {
      0% { transform: scale(0.97); background: #23293a; }
      60% { transform: scale(1.04); background: #334155; }
      100% { transform: scale(1); background: #1a2233; }
    }
    @keyframes welcomePop {
      0% { transform: scale(0.92); opacity: 0; }
      70% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      background: #23293a;
      border-radius: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 8px;
    }
    /* Responsive */
    @media (max-width: 900px) {
      #container { flex-direction: column; align-items: stretch; gap: 18px; }
      #canvasCard, #info { max-width: 100%; width: 100%; }
    }
    /* Bot√≥n calcular */
    .lil-gui .controller:last-child button {
      background: #475569;
      color: #fff;
      border-radius: 5px;
      border: none;
      font-weight: 600;
      padding: 7px 0;
      transition: background 0.2s;
      margin-top: 6px;
    }
    .lil-gui .controller:last-child button:hover {
      background: #6366f1;
    }
    /* Mejorar campos de entrada */
    .lil-gui input[type="text"], .lil-gui input[type="number"] {
      background: #23293a;
      border: 1px solid #334155;
      border-radius: 4px;
      color: #e5e7eb;
      font-size: 1em;
      padding: 3px 6px;
      transition: border 0.2s;
    }
    .lil-gui input[type="text"]:focus, .lil-gui input[type="number"]:focus {
      border: 1.5px solid #6366f1;
      outline: none;
    }
    /* Mejorar selectores */
    .lil-gui select {
      background: #23293a;
      border: 1px solid #334155;
      border-radius: 4px;
      color: #e5e7eb;
      font-size: 1em;
      padding: 3px 6px;
      transition: border 0.2s;
    }
    .lil-gui select:focus {
      border: 1.5px solid #6366f1;
      outline: none;
    }
    /* Ajuste para labels lil-gui */
    .lil-gui .name {
      color: #cbd5e1 !important;
    }
    /* Ajuste para valores lil-gui */
    .lil-gui .c input, .lil-gui .c select {
      color: #a3e635 !important;
    }
    /* Pantalla de bienvenida */
    #welcomeModal {
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(24,30,42,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s;
      opacity: 1;
      pointer-events: all;
    }
    #welcomeModal.hide {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.7s;
    }
    #welcomeBox {
      background: #23293a;
      color: #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 8px 32px 0 rgba(20,30,50,0.33);
      padding: 38px 36px 30px 36px;
      text-align: center;
      max-width: 90vw;
      min-width: 280px;
      border: 1.5px solid #334155;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      animation: welcomePop 0.7s;
    }
    #welcomeBox h1 {
      font-size: 2.1rem;
      margin: 0 0 12px 0;
      color: #a3e635;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    #welcomeBox p {
      font-size: 1.13rem;
      color: #cbd5e1;
      margin: 0 0 8px 0;
    }
  </style>
</head>
<body>
  <!-- Apartado de bienvenida -->
  <div id="welcomeModal">
    <div id="welcomeBox">
      <h1>¬°Bienvenido!</h1>
      <p>Proyecto: √Årea bajo la curva con m√©todos num√©ricos</p>
      <p style="font-size:1rem; color:#a3aed6; margin-top:10px;">Espere un momento...</p>
    </div>
  </div>
  <h2>√Årea bajo la curva: M√©todos Num√©ricos</h2>
  <div id="container">
    <div id="canvasCard" style="position:relative;">
      <!-- Panel de controles de la gr√°fica -->
      <div id="plotControls" style="position:absolute;top:18px;right:18px;z-index:10;display:flex;gap:8px;">
        <button id="btnDownload" title="Descargar imagen" style="background:#334155;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer;font-size:1.1em;box-shadow:0 1px 4px #181e2a33;">üì∑</button>
        <button id="btnZoomIn" title="Zoom +" style="background:#334155;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer;font-size:1.1em;">Ôºã</button>
        <button id="btnZoomOut" title="Zoom -" style="background:#334155;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer;font-size:1.1em;">Ôºç</button>
        <button id="btnZoomReset" title="Restablecer zoom" style="background:#334155;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer;font-size:1.1em;">‚ü≥</button>
        <button id="btnPanMode" title="Mover gr√°fica" style="background:#334155;color:#fff;border:none;border-radius:5px;padding:6px 10px;cursor:pointer;font-size:1.1em;">üñêÔ∏è</button>
      </div>
      <canvas id="plot" width="800" height="420"></canvas>
    </div>
    <div id="info">
      <div id="guiContainer"></div>
      <div class="result" id="output">
        <strong>Resultado:</strong>
        <div id="resultValue">-</div>
        <div class="hint">Ejemplos: <code>sin(x)</code>, <code>x^2</code>, <code>exp(-x^2)</code>, <code>log(x+1)</code></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- par√°metros iniciales ---
  const params = {
    expr: 'sin(x)',
    a: 0,
    b: Math.PI,
    n: 200,
    method: 'Simpson', // Riemann, Trapecio, Simpson, Adaptativa
    riemannType: 'medio', // izq, der, medio
    tol: 1e-6,
    compute: () => computeAndPlot()
  };

  // --- Inicializar GUI ---
  const gui = new lil.GUI({ container: document.getElementById('guiContainer') });
  gui.add(params, 'expr').name('Funci√≥n f(x)').onFinishChange(()=>computeAndPlot());
  gui.add(params, 'a', -100, 100).step(0.1).name('a').onFinishChange(()=>computeAndPlot());
  gui.add(params, 'b', -100, 100).step(0.1).name('b').onFinishChange(()=>computeAndPlot());
  gui.add(params, 'n', 2, 5000).step(1).name('N (subint.)').onFinishChange(()=>computeAndPlot());
  gui.add(params, 'method', ['Riemann','Trapecio','Simpson','Adaptativa']).name('M√©todo').onChange(()=>computeAndPlot());
  gui.add(params, 'riemannType', ['izq','der','medio']).name('Tipo Riemann').onChange(()=>computeAndPlot());
  gui.add(params, 'tol', 1e-10, 1e-2).step(1e-6).name('Tol. (adapt.)').onChange(()=>computeAndPlot());
  gui.add(params, 'compute').name('Calcular ahora');

  // --- Chart.js setup ---
  const ctx = document.getElementById('plot').getContext('2d');

  // Plugin para dibujar ejes X/Y infinitos (de borde a borde del canvas, no solo del chartArea)
  const infiniteAxesPlugin = {
    id: 'infiniteAxes',
    afterDraw(chart) {
      const {ctx, scales} = chart;
      const canvas = chart.canvas;
      ctx.save();
      // Eje X (y=0)
      if (scales.y.min < 0 && scales.y.max > 0) {
        const y0 = scales.y.getPixelForValue(0);
        ctx.strokeStyle = '#22d3ee';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, y0);
        ctx.lineTo(canvas.width, y0);
        ctx.stroke();
      }
      // Eje Y (x=0)
      if (scales.x.min < 0 && scales.x.max > 0) {
        const x0 = scales.x.getPixelForValue(0);
        ctx.strokeStyle = '#f59e42';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x0, 0);
        ctx.lineTo(x0, canvas.height);
        ctx.stroke();
      }
      ctx.restore();
    }
  };

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'f(x)', data: [], fill: false, tension: 0.15, pointRadius: 0, borderWidth: 2, borderColor: '#6366f1', backgroundColor: '#6366f1' },
        { label: '√Årea aproximada', data: [], fill: true, pointRadius: 0, borderWidth: 0, backgroundColor: 'rgba(99,102,241,0.13)', borderColor: 'rgba(99,102,241,0.13)' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#fff',
          titleColor: '#6366f1',
          bodyColor: '#222',
          borderColor: '#6366f1',
          borderWidth: 1,
          padding: 10,
          caretSize: 7,
          displayColors: false
        }
      },
      scales: {
        x: {
          type: 'linear',
          position: 'bottom',
          title: { display: true, text: 'x', color: '#475569', font: { weight: 'bold' } },
          grid: {
            color: '#e0e7ff',
            lineWidth: 1
          },
          ticks: { color: '#64748b' }
        },
        y: {
          title: { display: true, text: 'f(x)', color: '#475569', font: { weight: 'bold' } },
          grid: {
            color: '#e0e7ff',
            lineWidth: 1
          },
          ticks: { color: '#64748b' }
        }
      },
      animation: {
        duration: 900,
        easing: 'easeOutQuart'
      },
      hover: {
        mode: 'nearest',
        intersect: false,
        animationDuration: 400
      }
    },
    plugins: [infiniteAxesPlugin]
  });

  // --- animaci√≥n de fade-in para el resultado ---
  function animateResult() {
    const output = document.getElementById('output');
    output.classList.remove('animated');
    void output.offsetWidth; // trigger reflow
    output.classList.add('animated');
  }

  // --- util: parsear expresi√≥n segura ---
  function compileExpr(expr) {
    try {
      const node = math.compile(expr);
      node.evaluate({ x: 0 }); // test
      return node;
    } catch (e) {
      throw new Error('Expresi√≥n inv√°lida: ' + e.message);
    }
  }

  // --- M√©todos num√©ricos ---
  function riemann(fnode, a, b, n, tipo='medio') {
    const h = (b - a) / n;
    let sum = 0;
    for (let i = 0; i < n; i++) {
      let x;
      if (tipo === 'izq') x = a + i*h;
      else if (tipo === 'der') x = a + (i+1)*h;
      else x = a + (i+0.5)*h;
      sum += Number(fnode.evaluate({x}));
    }
    return sum * h;
  }

  function trapezoid(fnode, a, b, n) {
    const h = (b - a) / n;
    let sum = 0.5*(fnode.evaluate({x:a}) + fnode.evaluate({x:b}));
    for (let i=1; i<n; i++) {
      sum += fnode.evaluate({x: a + i*h});
    }
    return sum*h;
  }

  function simpson(fnode, a, b, n) {
    if (n%2===1) n++;
    const h = (b-a)/n;
    let sum = fnode.evaluate({x:a}) + fnode.evaluate({x:b});
    for (let i=1;i<n;i++) {
      const x = a+i*h;
      sum += (i%2===0 ? 2 : 4) * fnode.evaluate({x});
    }
    return sum*h/3;
  }

  function adaptiveSimpson(fnode, a, b, tol, maxRec=20, depth=0) {
    const S = simpson(fnode, a, b, 2);
    function recurse(fnode,a,b,eps,S,fa,fb,fc,depth) {
      const c=(a+b)/2;
      const h=(b-a)/2;
      const d=(a+c)/2, e=(c+b)/2;
      const fd=fnode.evaluate({x:d});
      const fe=fnode.evaluate({x:e});
      const Sleft=(h/3)*(fa+4*fd+fc);
      const Sright=(h/3)*(fc+4*fe+fb);
      const S2=Sleft+Sright;
      if (depth>maxRec) return S2;
      if (Math.abs(S2-S)<=15*eps) return S2+(S2-S)/15;
      return recurse(fnode,a,c,eps/2,Sleft,fa,fc,fd,depth+1)+
             recurse(fnode,c,b,eps/2,Sright,fc,fb,fe,depth+1);
    }
    const fa=fnode.evaluate({x:a});
    const fb=fnode.evaluate({x:b});
    const fc=fnode.evaluate({x:(a+b)/2});
    return recurse(fnode,a,b,tol,S,fa,fb,fc,depth);
  }

  // --- graficar ---
  function sampleFunction(fnode, a, b, samples=400) {
    const xs = [], ys=[];
    for (let i=0;i<=samples;i++) {
      const x = a+(b-a)*(i/samples);
      let y = Number(fnode.evaluate({x}));
      if (!isFinite(y)) y = NaN;
      xs.push(x); ys.push(y);
    }
    return {xs,ys};
  }

  // --- Controles de la gr√°fica ---
  let zoomLevel = 1;
  let xMin0, xMax0, yMin0, yMax0;
  let lastYRange = null;

  function getCurrentYRange() {
    const yVals = chart.data.datasets[0].data.map(pt => pt.y).filter(y => isFinite(y));
    if (!yVals.length) return [-1, 1];
    const min = Math.min(...yVals), max = Math.max(...yVals);
    // Evitar rango cero
    return min === max ? [min-1, max+1] : [min, max];
  }

  function saveOriginalRanges() {
    if (!xMin0 || !xMax0) {
      const xs = chart.data.labels;
      xMin0 = Math.min(...xs);
      xMax0 = Math.max(...xs);
    }
    if (!yMin0 || !yMax0) {
      [yMin0, yMax0] = getCurrentYRange();
      lastYRange = [yMin0, yMax0];
    }
  }

  function setZoom(level) {
    zoomLevel = Math.max(0.2, Math.min(level, 10));
    saveOriginalRanges();
    const xCenter = (xMin0 + xMax0) / 2;
    const xRange = (xMax0 - xMin0) / zoomLevel / 2;
    chart.options.scales.x.min = xCenter - xRange;
    chart.options.scales.x.max = xCenter + xRange;

    // Y: recalcula seg√∫n zoom, pero mantiene centro
    let [yMin, yMax] = lastYRange || getCurrentYRange();
    const yCenter = (yMin + yMax) / 2;
    const yRange = (yMax - yMin) / zoomLevel / 2 || 1;
    chart.options.scales.y.min = yCenter - yRange;
    chart.options.scales.y.max = yCenter + yRange;
    chart.update();
  }

  function resetZoom() {
    zoomLevel = 1;
    saveOriginalRanges();
    chart.options.scales.x.min = xMin0;
    chart.options.scales.x.max = xMax0;
    [yMin0, yMax0] = getCurrentYRange();
    lastYRange = [yMin0, yMax0];
    chart.options.scales.y.min = yMin0;
    chart.options.scales.y.max = yMax0;
    chart.update();
  }

  document.getElementById('btnZoomIn').onclick = () => setZoom(zoomLevel * 1.3);
  document.getElementById('btnZoomOut').onclick = () => setZoom(zoomLevel / 1.3);
  document.getElementById('btnZoomReset').onclick = () => resetZoom();

  // Descargar imagen
  document.getElementById('btnDownload').onclick = () => {
    const link = document.createElement('a');
    link.download = 'grafica-area.png';
    link.href = document.getElementById('plot').toDataURL('image/png');
    link.click();
  };

  // Al recalcular, actualizar rangos originales y zoom
  function updateZoomRanges() {
    xMin0 = xMax0 = yMin0 = yMax0 = null;
    lastYRange = null;
    resetZoom();
  }

  // --- Pan Mode (mover gr√°fica con mouse arrastrando) ---
  let panMode = false;
  let panStart = null;
  let panOrigin = null;

  document.getElementById('btnPanMode').onclick = function() {
    panMode = !panMode;
    this.style.background = panMode ? '#6366f1' : '#334155';
    document.body.style.cursor = panMode ? 'grab' : '';
  };

  const plotCanvas = document.getElementById('plot');
  plotCanvas.addEventListener('mousedown', function(e) {
    if (!panMode) return;
    panStart = { x: e.offsetX, y: e.offsetY };
    panOrigin = {
      xMin: chart.options.scales.x.min,
      xMax: chart.options.scales.x.max,
      yMin: chart.options.scales.y.min,
      yMax: chart.options.scales.y.max
    };
    document.body.style.cursor = 'grabbing';
  });
  plotCanvas.addEventListener('mouseup', function() {
    if (!panMode) return;
    panStart = null;
    document.body.style.cursor = panMode ? 'grab' : '';
  });
  plotCanvas.addEventListener('mouseleave', function() {
    if (!panMode) return;
    panStart = null;
    document.body.style.cursor = panMode ? 'grab' : '';
  });
  plotCanvas.addEventListener('mousemove', function(e) {
    if (!panMode || !panStart) return;
    const rect = plotCanvas.getBoundingClientRect();
    const dx = (e.offsetX - panStart.x) / rect.width;
    const dy = (e.offsetY - panStart.y) / rect.height;
    const xRange = panOrigin.xMax - panOrigin.xMin;
    const yRange = panOrigin.yMax - panOrigin.yMin;
    chart.options.scales.x.min = panOrigin.xMin - dx * xRange;
    chart.options.scales.x.max = panOrigin.xMax - dx * xRange;
    chart.options.scales.y.min = panOrigin.yMin + dy * yRange;
    chart.options.scales.y.max = panOrigin.yMax + dy * yRange;
    chart.update('none');
  });

  // --- main ---
  function computeAndPlot() {
    const out = document.getElementById('resultValue');
    out.textContent = '...';
    try {
      if (params.a===params.b) throw new Error('a y b no pueden ser iguales');
      const fnode = compileExpr(params.expr);
      let res;
      if (params.method==='Riemann') res = riemann(fnode, params.a, params.b, params.n, params.riemannType);
      else if (params.method==='Trapecio') res = trapezoid(fnode, params.a, params.b, params.n);
      else if (params.method==='Simpson') res = simpson(fnode, params.a, params.b, params.n);
      else res = adaptiveSimpson(fnode, params.a, params.b, params.tol);

      // graficar funci√≥n
      const samp = sampleFunction(fnode, Math.min(params.a,params.b), Math.max(params.a,params.b), 600);
      chart.data.labels = samp.xs;
      chart.data.datasets[0].data = samp.xs.map((x,i)=>({x, y:samp.ys[i]}));
      chart.data.datasets[1].data = samp.xs.map((x,i)=>({x, y:samp.ys[i]}));
      chart.update();
      updateZoomRanges();

      out.textContent = res.toFixed(8);
      animateResult();
    } catch(err) {
      out.textContent = 'Error: '+err.message;
      animateResult();
    }
  }

  // Pantalla de bienvenida
  window.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('welcomeModal');
    setTimeout(() => {
      modal.classList.add('hide');
      setTimeout(() => { modal.style.display = 'none'; }, 800);
    }, 4000); // Cambiado a 6 segundos
    // h2 y #container ya tienen animaci√≥n CSS
  });

  // --- animaci√≥n inicial de fade-in ---
  window.addEventListener('DOMContentLoaded', () => {
    // h2 y #container ya tienen animaci√≥n CSS
  });

  computeAndPlot();
})();
</script>
</body>
</html>